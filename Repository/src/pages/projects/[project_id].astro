---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Separator from "../../components/Separator.astro";
import ProjectGrid from "../../components/ProjectGrid.astro";
import { fetchGithubRepos, type GitHubRepo } from "../../lib/github";

export const getStaticPaths = async () => {
  const githubUsername = "Karthikprasadm";
  const githubToken = import.meta.env.GITHUB_TOKEN ?? process.env.GITHUB_TOKEN;
  const repos = await fetchGithubRepos(githubUsername, githubToken);
  return repos.map((repo, index) => {
    const prevProject = repos[(index - 1 + repos.length) % repos.length];
    const nextProjects = [
      repos[(index + 1) % repos.length],
      repos[(index + 2) % repos.length],
    ];
    const nextProject = repos[(index + 1) % repos.length];
    return {
      params: { project_id: repo.name },
      props: { repo, nextProjects, prevProject, nextProject },
    };
  });
};

const { repo, nextProjects, prevProject, nextProject } = Astro.props as {
  repo: GitHubRepo;
  nextProjects: GitHubRepo[];
  prevProject: GitHubRepo;
  nextProject: GitHubRepo;
};

const baseUrl = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL.slice(0, -1)
  : import.meta.env.BASE_URL;

const imageSrc =
  repo.owner?.avatar_url ||
  `https://opengraph.githubassets.com/1/${repo.full_name}`;
const description =
  repo.description ||
  "A GitHub project from the Mnmnts repository collection.";
const language = repo.language || "Project";
---

<BaseLayout title={repo.name}>
  <section data-project-id={repo.name}>
    <header class="title-header">
      <h2>
        {repo.name}
        <span class="faded">({repo.full_name})</span>
      </h2>
      <div>
        <a class="back" href={`${baseUrl}/`}>View all</a>
        <span class="faded">/</span>
        <a href={repo.html_url} target="_blank" rel="noreferrer">GitHub</a>
        <span class="faded">/</span>
        <a
          class="project-nav"
          href={`${baseUrl}/projects/${prevProject.name}`}
          aria-label="Previous project">
          &lsaquo;
        </a>
        <a
          class="project-nav"
          href={`${baseUrl}/projects/${nextProject.name}`}
          aria-label="Next project">
          &rsaquo;
        </a>
      </div>
    </header>
    <Separator />
    <div class="content-wrap">
      <img class="image fade-in" id="project-image" src={imageSrc} alt={repo.name} />
      <div class="content">
        <h3>Overview</h3>
        <p id="project-overview">{description}</p>
        <dl>
          <dt>Language</dt><dd id="project-language">{language}</dd>
        </dl>
      </div>
      <div class="albums">
        <div class="next-projects-title">
          <h3>Next Projects</h3>
          <button class="heart-button" type="button" aria-label="Unlock projects">
            <img
              class="line-favicon"
              src={`${baseUrl}/heart_favicon/favicon-32x32.png`}
              alt=""
              aria-hidden="true"
              loading="lazy"
            />
          </button>
        </div>
        <ProjectGrid projects={nextProjects} />
      </div>
    </div>
  </section>
</BaseLayout>

<dialog class="password-modal" aria-labelledby="password-title">
  <form method="dialog">
    <header>
      <h3 id="password-title">Enter password</h3>
      <button
        class="close"
        type="submit"
        value="cancel"
        formnovalidate
        aria-label="Close">
        Ã—
      </button>
    </header>
    <label class="field">
      <span>Password</span>
      <input
        type="password"
        name="password"
        autocomplete="current-password"
        required
      />
    </label>
    <p class="password-error" role="alert" hidden>Incorrect password.</p>
    <menu>
      <button type="submit" value="cancel" formnovalidate>Cancel</button>
      <button type="submit" value="submit">Submit</button>
    </menu>
  </form>
</dialog>

<input class="image-input" type="file" accept="image/*" hidden />

<style>
  .content-wrap {
    grid-template-areas: "img" "content" "albums";
    grid-template-columns: 100%;
    @media screen and (min-width: 44em) {
      grid-template-columns: 1fr auto;
      grid-template-areas: "img img" "content albums";
    }
    @media screen and (min-width: 50em) {
      grid-template-columns: 30vw 1fr 170px;
      grid-template-areas: "img content albums";
    }
  }
  .albums {
    grid-area: albums;
  }
  .project-nav {
    font-weight: 700;
    font-size: 1.35em;
  }
  .line-favicon {
    width: 16px;
    height: 16px;
    display: inline-block;
    vertical-align: middle;
  }
  .heart-button {
    border: 0;
    padding: 0;
    background: transparent;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
  }
  .heart-button:focus-visible {
    outline: 1px solid currentColor;
    outline-offset: 4px;
  }
  .next-projects-title {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 1rem;
  }
  .next-projects-title h3 {
    margin: 0;
    line-height: 1;
  }
  .image {
    width: 100%;
    height: 70vh;
    object-fit: cover;
  }
  .image.editable {
    cursor: pointer;
    outline: 1px dashed rgba(255, 255, 255, 0.25);
    outline-offset: 6px;
  }
  .password-modal {
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    background: rgba(10, 10, 12, 0.95);
    color: inherit;
    padding: 1.5rem;
    width: min(90vw, 360px);
  }
  .password-modal::backdrop {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
  }
  .password-modal form {
    display: grid;
    gap: 1rem;
  }
  .password-modal header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .password-modal .close {
    border: 0;
    background: transparent;
    color: inherit;
    font-size: 1.25rem;
    cursor: pointer;
  }
  .password-modal .field {
    display: grid;
    gap: 0.5rem;
  }
  .password-modal .password-error {
    color: #ffb347;
    margin: 0;
    font-size: 0.9rem;
  }
  .password-modal input {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 8px;
    color: inherit;
    padding: 0.5rem 0.75rem;
  }
  .password-modal menu {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    padding: 0;
    margin: 0;
  }
  .password-modal button {
    font: inherit;
  }
  .edit-mode #project-overview,
  .edit-mode #project-language {
    cursor: text;
    outline: 1px dashed rgba(255, 255, 255, 0.25);
    outline-offset: 4px;
  }
  .content p:last-child {
    margin-top: 2.5rem;
    display: flex;
  }
</style>

<script src="../../scripts/projectEditor.js"></script>

